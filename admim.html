<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Amanda Nails</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 
    <style>
        body { padding-top: 50px; }
        .admin-container { max-width: 800px; margin: 0 auto; padding: 2rem; }
        .service-item-admin { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1rem; border-bottom: 1px solid var(--glass-border); 
        }
        .btn-delete { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .admin-form { margin-bottom: 3rem; display: grid; gap: 10px; }
        .admin-form input, .admin-form label { font-size: 1rem; }
        .status-msg { text-align: center; margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container admin-container glass-card">
        
        <h1 style="font-family: 'Playfair Display'; margin-bottom: 1rem;">Gerenciar Preços</h1>
        
        <form id="add-service-form" class="admin-form">
            <div class="input-group">
                <label>Nome do Serviço</label>
                <input type="text" id="admin-nome" placeholder="Ex: Alongamento em Gel" required>
            </div>
            <div class="input-group">
                <label>Preço (R$)</label>
                <input type="text" id="admin-preco" placeholder="Ex: 150,00" required>
            </div>
            <div class="input-group">
                <label>Ordem de exibição</label>
                <input type="number" id="admin-ordem" placeholder="Ex: 1" required>
            </div>
            <div class="input-group" style="flex-direction: row; align-items: center; gap: 10px;">
                <input type="checkbox" id="admin-popular" style="width: auto;">
                <label for="admin-popular" style="margin: 0;">Marcar como "Popular"?</label>
            </div>
            <button type="submit" class="btn-primary">Adicionar Serviço</button>
        </form>

        <h2>Serviços Atuais</h2>
        <div id="admin-lista-servicos" style="margin-bottom: 3rem;">
            <p>Carregando lista...</p>
        </div>

        <hr style="margin: 3rem 0; border-color: var(--glass-border);">
        <h1 style="font-family: 'Playfair Display'; margin-bottom: 1rem;">Gerenciar Galeria</h1>
        
        <form id="add-photo-form" class="admin-form">
            <div class="input-group">
                <label>Selecione uma Imagem do Computador ou Celular</label>
                <input type="file" id="admin-foto" accept="image/*" required style="padding: 10px; background: white; border-radius: 5px; color: black;">
            </div>
            <button type="submit" class="btn-primary" id="btn-upload-foto">Fazer Upload e Salvar</button>
        </form>

        <h2>Fotos Atuais da Galeria</h2>
        <div id="admin-lista-fotos" style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 3rem;">
            <p>Carregando fotos...</p>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // SUAS CREDENCIAIS DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBlsJiWRJ1GfKDyKu0AFVvUM4_3-4WuEes",
            authDomain: "amanda-nails-11f7b.firebaseapp.com",
            projectId: "amanda-nails-11f7b",
            storageBucket: "amanda-nails-11f7b.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ELEMENTOS DO DOM (SERVIÇOS)
        const listaServicos = document.getElementById('admin-lista-servicos');
        const addServiceForm = document.getElementById('add-service-form');
        
        // ELEMENTOS DO DOM (GALERIA)
        const addPhotoForm = document.getElementById('add-photo-form');
        const fileInput = document.getElementById('admin-foto');
        const btnUploadFoto = document.getElementById('btn-upload-foto');
        const listaFotos = document.getElementById('admin-lista-fotos');

        // SUA CHAVE DO IMGBB
        const IMGBB_API_KEY = "c6a9c5e9ae0280d0c772312e48d2d18d";

        // ========================
        // 1. LÓGICA DE SERVIÇOS
        // ========================
        async function carregarServicos() {
            listaServicos.innerHTML = '<p>Atualizando...</p>';
            const q = query(collection(db, "servicos"), orderBy("ordem", "asc"));
            const snapshot = await getDocs(q);
            
            listaServicos.innerHTML = '';
            snapshot.forEach((servico) => {
                const data = servico.data();
                const div = document.createElement('div');
                div.className = 'service-item-admin';
                div.innerHTML = `
                    <div>
                        <strong>${data.nome}</strong> - R$ ${data.preco} 
                        ${data.popular ? '<span class="badge">Popular</span>' : ''}
                    </div>
                    <button class="btn-delete" onclick="deletarItem('servicos', '${servico.id}')">Excluir</button>
                `;
                listaServicos.appendChild(div);
            });
        }

        addServiceForm.onsubmit = async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, "servicos"), {
                    nome: document.getElementById('admin-nome').value,
                    preco: document.getElementById('admin-preco').value,
                    ordem: Number(document.getElementById('admin-ordem').value),
                    popular: document.getElementById('admin-popular').checked
                });
                addServiceForm.reset();
                carregarServicos();
            } catch (err) {
                alert("Erro ao salvar serviço!");
                console.error(err);
            }
        };

        // ========================
        // 2. LÓGICA DE GALERIA
        // ========================
        async function carregarFotos() {
            listaFotos.innerHTML = '<p>Atualizando...</p>';
            const q = query(collection(db, "galeria"), orderBy("data_upload", "desc"));
            const snapshot = await getDocs(q);
            
            listaFotos.innerHTML = '';
            if (snapshot.empty) {
                listaFotos.innerHTML = '<p>Nenhuma foto na galeria.</p>';
                return;
            }

            snapshot.forEach((fotoDoc) => {
                const data = fotoDoc.data();
                const div = document.createElement('div');
                div.style = "position: relative; width: 120px; height: 120px;";
                div.innerHTML = `
                    <img src="${data.url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; border: 2px solid var(--accent-color);">
                    <button class="btn-delete" onclick="deletarItem('galeria', '${fotoDoc.id}')" style="position: absolute; top: -10px; right: -10px; border-radius: 50%; padding: 5px 10px; font-weight: bold; cursor: pointer;">X</button>
                `;
                listaFotos.appendChild(div);
            });
        }

        addPhotoForm.onsubmit = async (e) => {
            e.preventDefault();
            const file = fileInput.files[0];
            if (!file) return;

            btnUploadFoto.innerText = "Enviando Imagem... Aguarde";
            btnUploadFoto.disabled = true;

            const formData = new FormData();
            formData.append('image', file);

            try {
                // Envia para o ImgBB
                const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const imgbbData = await imgbbResponse.json();

                if (imgbbData.success) {
                    const imageUrl = imgbbData.data.url;

                    // Salva no Firebase
                    await addDoc(collection(db, "galeria"), {
                        url: imageUrl,
                        data_upload: new Date().toISOString()
                    });

                    addPhotoForm.reset();
                    carregarFotos();
                    alert("Foto adicionada à galeria com sucesso!");
                } else {
                    alert("Erro ao hospedar a imagem no ImgBB.");
                }
            } catch (err) {
                alert("O erro exato foi: " + err.message);
                console.error("Erro completo:", err);
            } finally {
                btnUploadFoto.innerText = "Fazer Upload e Salvar";
                btnUploadFoto.disabled = false;
            }
        };

        // ========================
        // 3. FUNÇÃO GLOBAL DELETAR
        // ========================
        window.deletarItem = async (colecao, id) => {
            if(confirm("Deseja realmente excluir este item?")) {
                try {
                    await deleteDoc(doc(db, colecao, id));
                    if(colecao === 'servicos') carregarServicos();
                    if(colecao === 'galeria') carregarFotos();
                } catch (err) {
                    alert("Erro ao excluir.");
                    console.error(err);
                }
            }
        }

        // Inicializar
        carregarServicos();
        carregarFotos();
    </script>
</body>
</html>